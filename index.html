<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verkaufsdaten Dashboard 2024</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f9fafb; }
        .container { max-width: 1280px; margin: 0 auto; padding: 24px; }
        h1 { font-size: 30px; font-weight: 700; color: #111827; margin-bottom: 24px; }
        h2 { font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 16px; }
        
        /* Grid */
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        
        /* Cards */
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        .kpi-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; }
        .kpi-icon { font-size: 24px; margin-bottom: 8px; }
        .kpi-label { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
        .kpi-value { font-size: 24px; font-weight: 700; color: #111827; margin-bottom: 4px; }
        .kpi-sub { font-size: 14px; color: #6b7280; }
        
        /* Insights */
        .insights-box { background: linear-gradient(to right, #eff6ff, #eef2ff); border: 1px solid #93c5fd; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
        .insight-item { display: flex; gap: 12px; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
        .insight-warning { background: #fef3c7; border: 1px solid #fcd34d; }
        .insight-info { background: #dbeafe; border: 1px solid #93c5fd; }
        
        /* Buttons */
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .btn { padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; text-align: left; font-size: 15px; font-weight: 500; transition: all 0.2s; }
        .btn:hover { border-color: #3b82f6; background: #f9fafb; }
        .btn.active { border-color: #3b82f6; background: #eff6ff; }
        
        /* Excel Button */
        .excel-btn { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; }
        .excel-btn:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        
        /* Answer Box */
        .answer-box { background: linear-gradient(to right, #eff6ff, #eef2ff); border: 1px solid #93c5fd; border-radius: 8px; padding: 16px; margin-top: 16px; }
        
        /* Quarters */
        .quarter-box { border-radius: 8px; padding: 24px; border: 2px solid; }
        .quarter-q1 { background: #f9fafb; border-color: #d1d5db; }
        .quarter-q2 { background: #eff6ff; border-color: #93c5fd; }
        .quarter-label { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
        .quarter-value { font-size: 28px; font-weight: 700; color: #111827; }
        .quarter-delta { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 600; margin-top: 12px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th { padding: 12px 16px; text-align: left; font-size: 14px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; background: #f9fafb; }
        td { padding: 12px 16px; font-size: 14px; border-bottom: 1px solid #e5e7eb; }
        tr:nth-child(even) td { background: #f9fafb; }
        
        /* Heatmap */
        .heat-cell { border-radius: 6px; padding: 12px; text-align: center; font-size: 12px; font-weight: 600; }
        .heat-high { background: #22c55e; color: white; }
        .heat-med-high { background: #86efac; color: #1e293b; }
        .heat-med { background: #fde047; color: #1e293b; }
        .heat-low { background: #f3f4f6; color: #6b7280; }
        
        /* Growth Colors */
        .growth-high { background: #dcfce7; color: #166534; }
        .growth-neutral { background: #f9fafb; color: #374151; }
        .growth-low { background: #fee2e2; color: #991b1b; }
        
        .trend-up { color: #16a34a; font-size: 16px; }
        .trend-down { color: #dc2626; font-size: 16px; }
        
        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; height: 400px; font-size: 20px; color: #6b7280; }
        .hidden { display: none; }
        
        /* Legend */
        .legend { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; padding: 16px; background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; margin-top: 16px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .legend-box { width: 24px; height: 24px; border-radius: 4px; }
        
        @media (max-width: 768px) {
            .grid-4, .grid-2, .btn-grid { grid-template-columns: 1fr; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Verkaufsdaten Analyse 2024</h1>
        
        <div style="margin-bottom: 24px;">
            <button onclick="exportToExcel()" class="excel-btn">
                üì• Excel Export
            </button>
        </div>
        
        <div id="loading" class="loading">Lade Daten...</div>
        
        <div id="content" class="hidden">
            <!-- KPIs -->
            <div id="kpis" class="grid-4"></div>
            
            <!-- Smart Insights -->
            <div class="insights-box">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                    <span style="font-size: 24px;">üí°</span>
                    <h2 style="margin: 0;">Smart Insights</h2>
                </div>
                <div id="insights"></div>
            </div>
            
            <!-- Frag-Buttons -->
            <div class="card">
                <h2>ü§î Frag die Daten</h2>
                <div id="questions" class="btn-grid"></div>
                <div id="answer" class="answer-box hidden"></div>
            </div>
            
            <!-- Q1 vs Q2 -->
            <div class="card">
                <h2>Zeitraum-Vergleich: Q1 vs Q2 2024</h2>
                <div id="quarters" class="grid-2"></div>
            </div>
            
            <!-- Heatmap -->
            <div class="card">
                <h2>Heatmap: Umsatz nach Region & Produkt</h2>
                <p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">Gesamtumsatz √ºber alle Monate (Jan - Jun 2024)</p>
                <div id="heatmap" style="overflow-x: auto;"></div>
                <div class="legend">
                    <span style="font-weight: 600;">Legende:</span>
                    <div class="legend-item"><div class="legend-box heat-high"></div><span>Hoch</span></div>
                    <div class="legend-item"><div class="legend-box heat-med-high"></div><span>Mittel-Hoch</span></div>
                    <div class="legend-item"><div class="legend-box heat-med"></div><span>Mittel</span></div>
                    <div class="legend-item"><div class="legend-box heat-low"></div><span>Niedrig</span></div>
                </div>
            </div>

            <!-- Pivot -->
            <div class="card">
                <h2>Pivot-Tabelle: Umsatz nach Region & Produkt</h2>
                <p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">Aktueller Monat (Juni 2024) mit Wachstumsrate zum Vormonat</p>
                <div id="pivot" style="overflow-x: auto;"></div>
                <div class="legend">
                    <span style="font-weight: 600;">Legende:</span>
                    <div class="legend-item"><div class="legend-box growth-high"></div><span>Wachstum > +15%</span></div>
                    <div class="legend-item"><div class="legend-box growth-neutral"></div><span>-15% bis +15%</span></div>
                    <div class="legend-item"><div class="legend-box growth-low"></div><span>R√ºckgang < -15%</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const csvData = `Datum,Region,Produkt,Kategorie,Verkaeufer,Anzahl,Einzelpreis,Umsatz
2024-01-05,Nord,Laptop ProBook 450,Elektronik,Schmidt,3,899.99,2699.97
2024-01-08,Sued,Office Stuhl Premium,Moebel,Mueller,5,249.50,1247.50
2024-01-12,Ost,Drucker LaserJet Pro,Elektronik,Weber,2,459.99,919.98
2024-01-15,West,Schreibtisch Eiche,Moebel,Fischer,1,599.00,599.00
2024-01-18,Nord,Monitor 27 Zoll,Elektronik,Schmidt,8,299.99,2399.92
2024-01-22,Sued,Tastatur Mechanisch,Elektronik,Mueller,12,89.99,1079.88
2024-01-25,Ost,Buerostuhl Basic,Moebel,Weber,6,149.99,899.94
2024-01-28,West,Laptop ProBook 450,Elektronik,Fischer,2,899.99,1799.98
2024-02-02,Nord,Rollcontainer,Moebel,Schmidt,4,129.99,519.96
2024-02-05,Sued,Drucker LaserJet Pro,Elektronik,Mueller,3,459.99,1379.97
2024-02-09,Ost,Monitor 27 Zoll,Elektronik,Weber,5,299.99,1499.95
2024-02-12,West,Maus Wireless,Elektronik,Fischer,15,29.99,449.85
2024-02-16,Nord,Schreibtisch Eiche,Moebel,Schmidt,2,599.00,1198.00
2024-02-19,Sued,Laptop ProBook 450,Elektronik,Mueller,4,899.99,3599.96
2024-02-23,Ost,Office Stuhl Premium,Moebel,Weber,3,249.50,748.50
2024-02-26,West,Tastatur Mechanisch,Elektronik,Fischer,10,89.99,899.90
2024-03-01,Nord,Drucker LaserJet Pro,Elektronik,Schmidt,1,459.99,459.99
2024-03-05,Sued,Monitor 27 Zoll,Elektronik,Mueller,7,299.99,2099.93
2024-03-08,Ost,Laptop ProBook 450,Elektronik,Weber,5,899.99,4499.95
2024-03-12,West,Buerostuhl Basic,Moebel,Fischer,8,149.99,1199.92
2024-03-15,Nord,Maus Wireless,Elektronik,Schmidt,20,29.99,599.80
2024-03-19,Sued,Schreibtisch Eiche,Moebel,Mueller,3,599.00,1797.00
2024-03-22,Ost,Tastatur Mechanisch,Elektronik,Weber,9,89.99,809.91
2024-03-26,West,Office Stuhl Premium,Moebel,Fischer,4,249.50,998.00
2024-03-29,Nord,Laptop ProBook 450,Elektronik,Schmidt,6,899.99,5399.94
2024-04-02,Sued,Rollcontainer,Moebel,Mueller,7,129.99,909.93
2024-04-05,Ost,Drucker LaserJet Pro,Elektronik,Weber,4,459.99,1839.96
2024-04-09,West,Monitor 27 Zoll,Elektronik,Fischer,6,299.99,1799.94
2024-04-12,Nord,Office Stuhl Premium,Moebel,Schmidt,5,249.50,1247.50
2024-04-16,Sued,Tastatur Mechanisch,Elektronik,Mueller,11,89.99,989.89
2024-04-19,Ost,Laptop ProBook 450,Elektronik,Weber,3,899.99,2699.97
2024-04-23,West,Schreibtisch Eiche,Moebel,Fischer,2,599.00,1198.00
2024-04-26,Nord,Maus Wireless,Elektronik,Schmidt,18,29.99,539.82
2024-04-30,Sued,Buerostuhl Basic,Moebel,Mueller,9,149.99,1349.91
2024-05-03,Ost,Monitor 27 Zoll,Elektronik,Weber,10,299.99,2999.90
2024-05-07,West,Drucker LaserJet Pro,Elektronik,Fischer,2,459.99,919.98
2024-05-10,Nord,Laptop ProBook 450,Elektronik,Schmidt,7,899.99,6299.93
2024-05-14,Sued,Office Stuhl Premium,Moebel,Mueller,6,249.50,1497.00
2024-05-17,Ost,Tastatur Mechanisch,Elektronik,Weber,13,89.99,1169.87
2024-05-21,West,Rollcontainer,Moebel,Fischer,5,129.99,649.95
2024-05-24,Nord,Schreibtisch Eiche,Moebel,Schmidt,1,599.00,599.00
2024-05-28,Sued,Maus Wireless,Elektronik,Mueller,22,29.99,659.78
2024-05-31,Ost,Laptop ProBook 450,Elektronik,Weber,4,899.99,3599.96
2024-06-04,West,Monitor 27 Zoll,Elektronik,Fischer,8,299.99,2399.92
2024-06-07,Nord,Buerostuhl Basic,Moebel,Schmidt,7,149.99,1049.93
2024-06-11,Sued,Drucker LaserJet Pro,Elektronik,Mueller,3,459.99,1379.97
2024-06-14,Ost,Office Stuhl Premium,Moebel,Weber,4,249.50,998.00
2024-06-18,West,Tastatur Mechanisch,Elektronik,Fischer,14,89.99,1259.86
2024-06-21,Nord,Laptop ProBook 450,Elektronik,Schmidt,5,899.99,4499.95
2024-06-25,Sued,Schreibtisch Eiche,Moebel,Mueller,2,599.00,1198.00
2024-06-28,Ost,Maus Wireless,Elektronik,Weber,19,29.99,569.81`;

        let data = [];
        let selectedQuestion = null;
        
        const fmt = (v) => new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(v);
        const getGrowthClass = (g) => g > 15 ? 'growth-high' : g < -15 ? 'growth-low' : 'growth-neutral';
        
        // Umlaute zur√ºck konvertieren
        const fixUmlauts = (str) => {
            return str
                .replace(/Sued/g, 'S√ºd')
                .replace(/Moebel/g, 'M√∂bel')
                .replace(/Mueller/g, 'M√ºller')
                .replace(/Buerostuhl/g, 'B√ºrostuhl')
                .replace(/Verkaeufer/g, 'Verk√§ufer');
        };
        
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => fixUmlauts(h));
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => fixUmlauts(v));
                const obj = {};
                headers.forEach((h, i) => {
                    const val = values[i];
                    obj[h] = isNaN(val) ? val : parseFloat(val);
                });
                return obj;
            });
        }
        
        function init() {
            data = parseCSV(csvData).map(r => ({
                ...r,
                Region: r.Region?.trim(),
                Produkt: r.Produkt?.trim(),
                Verk√§ufer: r.Verk√§ufer?.trim()
            }));
            
            renderKPIs();
            renderInsights();
            renderQuestions();
            renderQuarters();
            renderHeatmap();
            renderPivot();
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }
        
        function renderKPIs() {
            const total = data.reduce((s, r) => s + r.Umsatz, 0);
            const months = [...new Set(data.map(d => d.Datum.substring(0, 7)))].sort();
            const avg = total / months.length;
            
            const byRegion = {};
            data.forEach(r => byRegion[r.Region] = (byRegion[r.Region] || 0) + r.Umsatz);
            const best = Object.entries(byRegion).sort((a, b) => b[1] - a[1])[0];
            
            const byProduct = {};
            data.forEach(r => byProduct[r.Produkt] = (byProduct[r.Produkt] || 0) + r.Umsatz);
            const top = Object.entries(byProduct).sort((a, b) => b[1] - a[1])[0];
            
            const last = data.filter(d => d.Datum.startsWith(months[months.length - 1])).reduce((s, r) => s + r.Umsatz, 0);
            const prev = data.filter(d => d.Datum.startsWith(months[months.length - 2])).reduce((s, r) => s + r.Umsatz, 0);
            const growth = ((last - prev) / prev * 100).toFixed(1);
            
            document.getElementById('kpis').innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-icon">üí∞</div>
                    <div class="kpi-label">Gesamtumsatz</div>
                    <div class="kpi-value">${fmt(total)}</div>
                    <div class="kpi-sub">√ò ${fmt(avg)}/Monat</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üèÜ</div>
                    <div class="kpi-label">Beste Region</div>
                    <div class="kpi-value">${best[0]}</div>
                    <div class="kpi-sub">${fmt(best[1])}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üéØ</div>
                    <div class="kpi-label">Top Produkt</div>
                    <div class="kpi-value">${top[0]}</div>
                    <div class="kpi-sub">${fmt(top[1])}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">${growth >= 0 ? 'üìà' : 'üìâ'}</div>
                    <div class="kpi-label">Wachstumsrate</div>
                    <div class="kpi-value" style="color: ${growth >= 0 ? '#16a34a' : '#dc2626'}">${growth >= 0 ? '+' : ''}${growth}%</div>
                    <div class="kpi-sub">Monat-zu-Monat</div>
                </div>
            `;
        }
        
        function renderInsights() {
            const insights = [];
            const regions = ['Nord', 'S√ºd', 'Ost', 'West'];
            const products = [...new Set(data.map(d => d.Produkt))];
            const months = [...new Set(data.map(d => d.Datum.substring(0, 7)))].sort();
            const last2 = months.slice(-2);
            
            products.forEach(p => {
                regions.forEach(r => {
                    const sales = data.filter(d => d.Produkt === p && d.Region === r && last2.includes(d.Datum.substring(0, 7)));
                    if (sales.length === 0) {
                        insights.push({type: 'warning', text: `Keine ${p}-Verk√§ufe in ${r} in den letzten 2 Monaten`});
                    }
                });
            });
            
            const bySeller = {};
            data.forEach(r => bySeller[r.Verk√§ufer] = (bySeller[r.Verk√§ufer] || 0) + r.Umsatz);
            const topSeller = Object.entries(bySeller).sort((a, b) => b[1] - a[1])[0];
            insights.push({type: 'info', text: `Top-Performer: ${topSeller[0]} mit ${fmt(topSeller[1])}`});
            
            document.getElementById('insights').innerHTML = insights.slice(0, 4).map(i => `
                <div class="insight-item insight-${i.type}">
                    <span style="font-size: 20px;">${i.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                    <span style="font-size: 14px;">${i.text}</span>
                </div>
            `).join('');
        }
        
        function renderQuestions() {
            const questions = [
                {id: 'top-seller', q: 'Wer war der beste Verk√§ufer?'},
                {id: 'growth', q: 'Welches Produkt w√§chst am schnellsten?'},
                {id: 'potential', q: 'Welche Region hat Potenzial?'},
                {id: 'gaps', q: 'Wo gibt es ungenutzte Chancen?'}
            ];
            
            document.getElementById('questions').innerHTML = questions.map(q => `
                <button class="btn" onclick="showAnswer('${q.id}')">${q.q}</button>
            `).join('');
        }
        
        function showAnswer(id) {
            let answer = '';
            
            if (id === 'top-seller') {
                const sellers = {};
                data.forEach(r => sellers[r.Verk√§ufer] = (sellers[r.Verk√§ufer] || 0) + r.Umsatz);
                const top = Object.entries(sellers).sort((a, b) => b[1] - a[1])[0];
                answer = `${top[0]} war der beste Verk√§ufer mit ${fmt(top[1])} Gesamtumsatz.`;
            } else if (id === 'growth') {
                const months = [...new Set(data.map(d => d.Datum.substring(0, 7)))].sort();
                const products = [...new Set(data.map(d => d.Produkt))];
                const growth = {};
                products.forEach(p => {
                    const last = data.filter(d => d.Produkt === p && d.Datum.startsWith(months[months.length - 1])).reduce((s, r) => s + r.Umsatz, 0);
                    const prev = data.filter(d => d.Produkt === p && d.Datum.startsWith(months[months.length - 2])).reduce((s, r) => s + r.Umsatz, 0);
                    if (prev > 0) growth[p] = ((last - prev) / prev * 100);
                });
                const fastest = Object.entries(growth).sort((a, b) => b[1] - a[1])[0];
                answer = `${fastest[0]} w√§chst am schnellsten mit +${fastest[1].toFixed(1)}% zum Vormonat.`;
            } else if (id === 'potential') {
                const byRegion = {};
                ['Nord', 'S√ºd', 'Ost', 'West'].forEach(r => {
                    byRegion[r] = data.filter(d => d.Region === r).reduce((s, row) => s + row.Umsatz, 0);
                });
                const sorted = Object.entries(byRegion).sort((a, b) => a[1] - b[1]);
                answer = `${sorted[0][0]} hat mit ${fmt(sorted[0][1])} den niedrigsten Umsatz und das gr√∂√üte Potenzial.`;
            } else {
                answer = 'Diese Analyse zeigt Region-Produkt-Kombinationen ohne Verk√§ufe.';
            }
            
            const answerBox = document.getElementById('answer');
            answerBox.innerHTML = `
                <div style="margin-bottom: 8px; font-weight: 600; color: #1e40af;">Antwort:</div>
                <p style="color: #374151;">${answer}</p>
            `;
            answerBox.classList.remove('hidden');
            
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function renderQuarters() {
            const q1 = data.filter(d => d.Datum.substring(5, 7) <= '03').reduce((s, r) => s + r.Umsatz, 0);
            const q2 = data.filter(d => d.Datum.substring(5, 7) >= '04' && d.Datum.substring(5, 7) <= '06').reduce((s, r) => s + r.Umsatz, 0);
            const delta = ((q2 - q1) / q1 * 100).toFixed(1);
            
            document.getElementById('quarters').innerHTML = `
                <div class="quarter-box quarter-q1">
                    <div class="quarter-label">Q1 2024 (Jan - M√§rz)</div>
                    <div class="quarter-value">${fmt(q1)}</div>
                </div>
                <div class="quarter-box quarter-q2">
                    <div class="quarter-label">Q2 2024 (Apr - Juni)</div>
                    <div class="quarter-value">${fmt(q2)}</div>
                    <div class="quarter-delta" style="color: ${delta >= 0 ? '#16a34a' : '#dc2626'}">
                        <span class="${delta >= 0 ? 'trend-up' : 'trend-down'}">${delta >= 0 ? '‚Üë' : '‚Üì'}</span>
                        ${delta >= 0 ? '+' : ''}${delta}%
                    </div>
                </div>
            `;
        }
        
        function renderHeatmap() {
            const regions = ['Nord', 'S√ºd', 'Ost', 'West'];
            const products = [...new Set(data.map(d => d.Produkt))];
            const byKey = {};
            data.forEach(r => {
                const k = `${r.Region}-${r.Produkt}`;
                byKey[k] = (byKey[k] || 0) + r.Umsatz;
            });
            
            const allRevs = Object.values(byKey).sort((a, b) => a - b);
            const q1 = allRevs[Math.floor(allRevs.length * 0.25)];
            const q2 = allRevs[Math.floor(allRevs.length * 0.5)];
            const q3 = allRevs[Math.floor(allRevs.length * 0.75)];
            
            const getHeatClass = (v) => v >= q3 ? 'heat-high' : v >= q2 ? 'heat-med-high' : v >= q1 ? 'heat-med' : 'heat-low';
            
            let html = '<table><thead><tr><th>Region</th>';
            products.forEach(p => html += `<th>${p}</th>`);
            html += '</tr></thead><tbody>';
            
            regions.forEach(r => {
                html += `<tr><td style="font-weight: 600;">${r}</td>`;
                products.forEach(p => {
                    const val = byKey[`${r}-${p}`] || 0;
                    html += `<td><div class="heat-cell ${getHeatClass(val)}">${fmt(val)}</div></td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('heatmap').innerHTML = html;
        }
        
        function renderPivot() {
            const regions = ['Nord', 'S√ºd', 'Ost', 'West'];
            const products = [...new Set(data.map(d => d.Produkt))];
            const months = [...new Set(data.map(d => d.Datum.substring(0, 7)))].sort();
            
            const currentMonth = months[months.length - 1];
            const previousMonth = months[months.length - 2];
            
            const currentData = {};
            const previousData = {};
            
            data.forEach(r => {
                const month = r.Datum.substring(0, 7);
                const key = `${r.Region}-${r.Produkt}`;
                
                if (month === currentMonth) {
                    currentData[key] = (currentData[key] || 0) + r.Umsatz;
                } else if (month === previousMonth) {
                    previousData[key] = (previousData[key] || 0) + r.Umsatz;
                }
            });
            
            let html = '<table><thead><tr><th>Region</th>';
            products.forEach(p => html += `<th>${p}</th>`);
            html += '</tr></thead><tbody>';
            
            regions.forEach(r => {
                html += `<tr><td style="font-weight: 600;">${r}</td>`;
                products.forEach(p => {
                    const key = `${r}-${p}`;
                    const currentRev = currentData[key] || 0;
                    const prevRev = previousData[key] || 0;
                    const growth = prevRev > 0 ? ((currentRev - prevRev) / prevRev * 100) : (currentRev > 0 ? 100 : 0);
                    const growthClass = getGrowthClass(growth);
                    
                    html += `
                        <td>
                            <div class="${growthClass}" style="border-radius: 6px; padding: 8px;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${fmt(currentRev)}</div>
                                <div style="font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                    <span class="${growth > 0 ? 'trend-up' : 'trend-down'}">${growth > 0 ? '‚Üë' : '‚Üì'}</span>
                                    ${growth.toFixed(1)}%
                                </div>
                            </div>
                        </td>
                    `;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('pivot').innerHTML = html;
        }
        
        window.addEventListener('load', init);
        
        function exportToExcel() {
            const months = [...new Set(data.map(d => d.Datum.substring(0, 7)))].sort();
            
            let xlsx = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
            xlsx += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ';
            xlsx += 'xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
            
            // Tab 1: KPIs
            xlsx += '<Worksheet ss:Name="KPIs"><Table>';
            xlsx += '<Row><Cell><Data ss:Type="String">Metrik</Data></Cell><Cell><Data ss:Type="String">Wert</Data></Cell></Row>';
            
            const total = data.reduce((s, r) => s + r.Umsatz, 0);
            const avg = total / months.length;
            
            xlsx += `<Row><Cell><Data ss:Type="String">Gesamtumsatz</Data></Cell><Cell><Data ss:Type="Number">${total.toFixed(2)}</Data></Cell></Row>`;
            xlsx += `<Row><Cell><Data ss:Type="String">Durchschnitt/Monat</Data></Cell><Cell><Data ss:Type="Number">${avg.toFixed(2)}</Data></Cell></Row>`;
            
            xlsx += '</Table></Worksheet>';
            
            // Tab 2: Rohdaten
            xlsx += '<Worksheet ss:Name="Rohdaten"><Table>';
            xlsx += '<Row>';
            xlsx += '<Cell><Data ss:Type="String">Datum</Data></Cell>';
            xlsx += '<Cell><Data ss:Type="String">Region</Data></Cell>';
            xlsx += '<Cell><Data ss:Type="String">Produkt</Data></Cell>';
            xlsx += '<Cell><Data ss:Type="String">Kategorie</Data></Cell>';
            xlsx += '<Cell><Data ss:Type="String">Verk√§ufer</Data></Cell>';
            xlsx += '<Cell><Data ss:Type="String">Anzahl</Data></Cell>';
            xlsx += '<Cell><Data ss:Type="String">Einzelpreis</Data></Cell>';
            xlsx += '<Cell><Data ss:Type="String">Umsatz</Data></Cell>';
            xlsx += '</Row>';
            
            data.forEach(row => {
                xlsx += '<Row>';
                xlsx += `<Cell><Data ss:Type="String">${row.Datum}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="String">${row.Region}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="String">${row.Produkt}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="String">${row.Kategorie}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="String">${row.Verk√§ufer}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="Number">${row.Anzahl}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="Number">${row.Einzelpreis}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="Number">${row.Umsatz}</Data></Cell>`;
                xlsx += '</Row>';
            });
            
            xlsx += '</Table></Worksheet>';
            
            // Tab 3: Pivot Juni 2024
            const regions = ['Nord', 'S√ºd', 'Ost', 'West'];
            const products = [...new Set(data.map(d => d.Produkt))];
            
            const currentMonth = months[months.length - 1];
            const previousMonth = months[months.length - 2];
            
            const currentData = {};
            const previousData = {};
            
            data.forEach(r => {
                const month = r.Datum.substring(0, 7);
                const key = `${r.Region}-${r.Produkt}`;
                
                if (month === currentMonth) {
                    currentData[key] = (currentData[key] || 0) + r.Umsatz;
                } else if (month === previousMonth) {
                    previousData[key] = (previousData[key] || 0) + r.Umsatz;
                }
            });
            
            xlsx += '<Worksheet ss:Name="Pivot Juni 2024"><Table>';
            xlsx += '<Row><Cell><Data ss:Type="String">Region</Data></Cell>';
            products.forEach(p => {
                xlsx += `<Cell><Data ss:Type="String">${p}</Data></Cell>`;
                xlsx += `<Cell><Data ss:Type="String">${p} Wachstum %</Data></Cell>`;
            });
            xlsx += '</Row>';
            
            regions.forEach(r => {
                xlsx += '<Row>';
                xlsx += `<Cell><Data ss:Type="String">${r}</Data></Cell>`;
                products.forEach(p => {
                    const key = `${r}-${p}`;
                    const currentRev = currentData[key] || 0;
                    const prevRev = previousData[key] || 0;
                    const growth = prevRev > 0 ? ((currentRev - prevRev) / prevRev * 100) : 0;
                    
                    xlsx += `<Cell><Data ss:Type="Number">${currentRev.toFixed(2)}</Data></Cell>`;
                    xlsx += `<Cell><Data ss:Type="Number">${growth.toFixed(1)}</Data></Cell>`;
                });
                xlsx += '</Row>';
            });
            
            xlsx += '</Table></Worksheet>';
            
            xlsx += '</Workbook>';
            
            const blob = new Blob([xlsx], {type: 'application/vnd.ms-excel'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Verkaufsdaten_Dashboard_' + new Date().toISOString().split('T')[0] + '.xls';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
